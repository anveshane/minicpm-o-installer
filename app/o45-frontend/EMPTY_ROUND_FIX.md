# ç©ºè½®æ¬¡ï¼ˆæ— éŸ³é¢‘ï¼‰é—®é¢˜ä¿®å¤æ–‡æ¡£

## é—®é¢˜æè¿°

åç«¯å¯èƒ½ä¼šå‡ºç°ä»¥ä¸‹æƒ…å†µï¼š
1. å‘é€ `<state><generate_start>` 
2. **æ²¡æœ‰å‘é€** `<state><audio_start>` æˆ–éŸ³é¢‘åŒ…
3. ç«‹å³å‘é€ `<state><generate_end>`

è¿™ç§æƒ…å†µä¸‹ï¼Œå‰ç«¯çŠ¶æ€ä¼šå¡åœ¨ `thinking`ï¼Œå› ä¸ºæ²¡æœ‰éŸ³é¢‘æ’­æ”¾ç»“æŸçš„ä¿¡å·è§¦å‘å‘é€ `play_end`ã€‚

## è§£å†³æ–¹æ¡ˆ

### 1. æ–°å¢çŠ¶æ€è¿½è¸ª

åœ¨ `state` ä¸­æ·»åŠ  `currentRoundHasAudio` æ ‡è®°ï¼š

```javascript
state.currentRoundHasAudio = false  // æ ‡è®°å½“å‰è½®æ¬¡æ˜¯å¦æœ‰éŸ³é¢‘
```

### 2. å…³é”®æ—¶æœºçš„æ ‡è®°è®¾ç½®

#### 2.1 æ”¶åˆ° `generate_start` æ—¶ï¼ˆé‡ç½®ä¸º falseï¼‰
```javascript
state.currentRoundHasAudio = false;
```

#### 2.2 æ”¶åˆ° `audio_start` æ—¶ï¼ˆæ ‡è®°ä¸º trueï¼‰
```javascript
state.currentRoundHasAudio = true;
```

#### 2.3 æ£€æµ‹åˆ° `speaking = true` æ—¶ï¼ˆæ ‡è®°ä¸º trueï¼‰
```javascript
state.currentRoundHasAudio = true;
```

### 3. åœ¨ `generate_end` æ—¶æ£€æµ‹ç©ºè½®æ¬¡

```javascript
if (!state.currentRoundHasAudio && state.status === 'thinking') {
    // è¿™æ˜¯ä¸€ä¸ªç©ºè½®æ¬¡ï¼ç›´æ¥å‘é€ play_end
    state.status = 'listening';
    sendPlayEnd('ç©ºè½®æ¬¡ï¼Œæ— éŸ³é¢‘');
    return;
}
```

## å¢å¼ºçš„æ—¥å¿—è¾“å‡º

### sendPlayEnd å‡½æ•°å¢å¼º

ç°åœ¨ä¼šè¾“å‡ºé†’ç›®çš„çº¢è‰²æ—¥å¿—ï¼š

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ›‘ [2024-12-30 10:23:45.678] å‘é€ play_end ç»™åç«¯
   åŸå› : ç©ºè½®æ¬¡ï¼Œæ— éŸ³é¢‘
   å½“å‰çŠ¶æ€: thinking â†’ listening
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

### ä¸åŒåœºæ™¯çš„åŸå› æ ‡è®°

| åœºæ™¯ | åŸå› æ–‡æœ¬ |
|------|---------|
| ç©ºè½®æ¬¡ | `ç©ºè½®æ¬¡ï¼Œæ— éŸ³é¢‘` |
| è§†é¢‘æ¨¡å¼ | `è§†é¢‘æ¨¡å¼ï¼Œæ— éŸ³é¢‘æ’­æ”¾` |
| é™é»˜æ£€æŸ¥é€šè¿‡ | `é™é»˜æ£€æŸ¥ï¼šéŸ³é¢‘æ’­æ”¾ç»“æŸ` |
| é¢å¤–300msæ£€æŸ¥ | `é™é»˜æ£€æŸ¥ï¼šé¢å¤–300msæ£€æŸ¥é€šè¿‡` |
| æœ€ç»ˆå¼ºåˆ¶åˆ‡æ¢ | `é™é»˜æ£€æŸ¥ï¼šæœ€ç»ˆå¼ºåˆ¶åˆ‡æ¢` |
| generate_endå¿«é€Ÿæ£€æŸ¥ | `generate_endï¼šå¿«é€Ÿæ£€æŸ¥é€šè¿‡` |
| generate_endé¢å¤–æ£€æŸ¥ | `generate_endï¼šé¢å¤–300msæ£€æŸ¥é€šè¿‡` |
| generate_endå¼ºåˆ¶åˆ‡æ¢ | `generate_endï¼šæœ€ç»ˆå¼ºåˆ¶åˆ‡æ¢` |

## çŠ¶æ€æµè½¬ç¤ºæ„å›¾

### æ­£å¸¸æµç¨‹ï¼ˆæœ‰éŸ³é¢‘ï¼‰
```
generate_start â†’ thinking â†’ audio_start (æ ‡è®°æœ‰éŸ³é¢‘) 
    â†’ speaking=true â†’ talking â†’ speaking=false 
    â†’ generate_end â†’ play_end â†’ listening
```

### ç©ºè½®æ¬¡æµç¨‹ï¼ˆæ— éŸ³é¢‘ï¼‰
```
generate_start â†’ thinking (æ— éŸ³é¢‘æ ‡è®°) 
    â†’ generate_end (æ£€æµ‹åˆ°ç©ºè½®æ¬¡) 
    â†’ ç«‹å³å‘é€ play_end â†’ listening
```

## æµ‹è¯•æ–¹æ³•

### æ§åˆ¶å°è°ƒè¯•å‘½ä»¤

```javascript
// 1. æŸ¥çœ‹å½“å‰è½®æ¬¡çŠ¶æ€
window.getCurrentRoundStatus()

// è¾“å‡ºç¤ºä¾‹ï¼š
{
    currentStatus: "thinking",
    generateEnd: false,
    currentRoundHasAudio: false,  // å…³é”®ï¼šæ˜¯å¦æœ‰éŸ³é¢‘
    playEndSent: false,
    remoteAudioActive: {},
    audioRoundsCount: 3,
    lastRound: { round: 2, generateStartAt: 12345.67, ... }
}

// 2. æŸ¥çœ‹ play_end é˜²æŠ¤çŠ¶æ€
window.getPlayEndGuardStatus()

// è¾“å‡ºç¤ºä¾‹ï¼š
{
    playEndSent: false,
    playEndTimestamp: 0,
    timeSincePlayEnd: "N/A",
    currentStatus: "thinking",
    generateEnd: false,
    currentRoundHasAudio: false,
    remoteAudioActive: {}
}
```

## æ’­æ”¾ç»“æŸæ£€æµ‹ä¼˜åŒ–

### åŒé‡æ£€æµ‹æœºåˆ¶

é‡‡ç”¨ **generate_end ä¿¡å· + éŸ³é¢‘æ’­æ”¾çŠ¶æ€** åŒé‡éªŒè¯ï¼Œç¡®ä¿ç²¾ç¡®åˆ¤æ–­ï¼š

#### 1. generate_end ä¼˜å…ˆæ£€æµ‹ï¼ˆæœ€å¿«ï¼‰
- æ”¶åˆ° `generate_end` ä¿¡å·ï¼ˆåç«¯æ˜ç¡®å®Œæˆç”Ÿæˆï¼‰
- **ç«‹å³æ£€æŸ¥**éŸ³é¢‘æ’­æ”¾çŠ¶æ€ï¼ˆDOM + remoteAudioActiveï¼‰
- å¦‚æœéŸ³é¢‘æœªæ’­æ”¾ â†’ ç»™äºˆ **100ms ç¼“å†²æ—¶é—´**ï¼ˆå¿«é€Ÿå“åº”ï¼‰
- å¦‚æœéŸ³é¢‘ä»åœ¨æ’­æ”¾ â†’ è¿›å…¥å»¶è¿Ÿæ£€æµ‹

**ä¼˜åŠ¿**ï¼š
- âœ… åç«¯ä¿¡å· + å‰ç«¯çŠ¶æ€åŒé‡éªŒè¯
- âœ… æé€Ÿå“åº”ï¼š**100ms**ï¼ˆç¼“å†²åç«‹å³åˆ‡æ¢ï¼‰
- âœ… å¹³å‡æ—¶å»¶é™ä½åˆ° **200-300ms**

**ä¸ºä»€ä¹ˆ100msç¼“å†²**ï¼š
- ç»™äºˆæœ€åéŸ³é¢‘åŒ…æœ€å°åˆ°è¾¾æ—¶é—´
- ä¼˜å…ˆè€ƒè™‘å¿«é€Ÿå“åº”
- å‡å°‘"æ¨¡å‹è¯´å®Œä½†è¿˜åœ¨å›ç­”"çš„ç­‰å¾…æ„Ÿ

#### 2. é™é»˜æ£€æµ‹æœºåˆ¶ï¼ˆå…œåº•ï¼‰
å½“ speaking = false è§¦å‘æ—¶çš„å¤‡ç”¨æœºåˆ¶ï¼š
- **ä¸»é™é»˜æ£€æŸ¥**ï¼š600msï¼ˆå¿«é€Ÿå“åº”ä¼˜å…ˆï¼‰
- **ç²¾ç¡®æ£€æŸ¥å»¶è¿Ÿ**ï¼š100msï¼ˆæœ€å°åŒ–ç­‰å¾…æ—¶é—´ï¼‰
- **é¢å¤–æ£€æŸ¥æ—¶é—´**ï¼š100msï¼ˆDOM æ˜¾ç¤ºä»åœ¨æ’­æ”¾æ—¶ï¼‰
- **æœ€ç»ˆå¼ºåˆ¶æ—¶é—´**ï¼š100msï¼ˆæœ€åä¿é™©æœºåˆ¶ï¼‰

**æ€»å“åº”æ—¶é—´**ï¼š
- æœ€å¿«ï¼š**100ms**ï¼ˆgenerate_end + 100msç¼“å†²ï¼‰âš¡âš¡âš¡
- å¸¸è§„ï¼š100ms - 250msï¼ˆgenerate_end + å»¶è¿Ÿæ£€æµ‹ï¼‰âš¡âš¡
- å…œåº•ï¼š600ms - 900msï¼ˆé™é»˜æ£€æµ‹æœºåˆ¶ï¼‰

**æ—¶é—´å¹³è¡¡è¯´æ˜**ï¼š
- 600ms ä¸»é™é»˜æ£€æŸ¥ï¼šå¿«é€Ÿå“åº”ä¸ºä¸»
- 100ms generate_end ç¼“å†²ï¼šæé€Ÿåˆ‡æ¢
- **å¹³å‡æ—¶å»¶ï¼š200-300ms**ï¼ˆå¤§éƒ¨åˆ†èµ° generate_end è·¯å¾„ï¼‰

**âš ï¸ æƒè¡¡è¯´æ˜**ï¼š
- æ­¤é…ç½®ä¼˜å…ˆè€ƒè™‘å¿«é€Ÿå“åº”
- å¯èƒ½å¶å°”å‡ºç°å»¶è¿ŸéŸ³é¢‘åŒ…ï¼ˆæ¦‚ç‡è¾ƒä½ï¼‰
- å¦‚é¢‘ç¹å‡ºç°å¯é€‚å½“å¢åŠ ç¼“å†²æ—¶é—´

## é¢„æœŸæ•ˆæœ

### ä¿®å¤å‰ âŒ
- åç«¯å‘é€ `generate_start` åç«‹å³ `generate_end`
- å‰ç«¯çŠ¶æ€å¡åœ¨ `thinking`
- æ°¸è¿œä¸ä¼šå‘é€ `play_end`
- åç»­å¯¹è¯æ— æ³•è¿›è¡Œ

### ä¿®å¤å âœ…
- æ£€æµ‹åˆ°ç©ºè½®æ¬¡ï¼ˆæ— éŸ³é¢‘ï¼‰
- è‡ªåŠ¨ä» `thinking` åˆ‡æ¢åˆ° `listening`
- ç«‹å³å‘é€ `play_end`
- è¾“å‡ºé†’ç›®çš„çº¢è‰²æ—¥å¿—ï¼š
  ```
  âš ï¸ æ£€æµ‹åˆ°ç©ºè½®æ¬¡ï¼ˆæ— éŸ³é¢‘ï¼‰ï¼Œç›´æ¥å‘é€ play_end
  åŸå› : ç©ºè½®æ¬¡ï¼Œæ— éŸ³é¢‘
  ```

## æ–‡ä»¶å˜æ›´æ¸…å•

- âœ… `src/hooks/useLiveKit.js`
  - æ–°å¢ `currentRoundHasAudio` çŠ¶æ€è¿½è¸ª
  - å¢å¼º `sendPlayEnd()` å‡½æ•°ï¼ˆæ·»åŠ åŸå› å‚æ•°å’Œé†’ç›®æ—¥å¿—ï¼‰
  - åœ¨ `generate_end` å¤„ç†ä¸­æ·»åŠ ç©ºè½®æ¬¡æ£€æµ‹
  - åœ¨ `generate_start`ã€`audio_start`ã€`speaking=true` æ—¶è®¾ç½®éŸ³é¢‘æ ‡è®°
  - æ–°å¢ `getCurrentRoundStatus()` è°ƒè¯•å‡½æ•°

## æ³¨æ„äº‹é¡¹

1. **ç©ºè½®æ¬¡å®šä¹‰**ï¼šä» `generate_start` åˆ° `generate_end` ä¹‹é—´ï¼Œæ—¢æ²¡æœ‰æ”¶åˆ° `audio_start`ï¼Œä¹Ÿæ²¡æœ‰æ£€æµ‹åˆ°å®é™…éŸ³é¢‘æ’­æ”¾ï¼ˆ`speaking=true`ï¼‰

2. **ä¼˜å…ˆçº§**ï¼šç©ºè½®æ¬¡æ£€æµ‹åœ¨ `generate_end` ä¸­æœ€å…ˆæ‰§è¡Œï¼Œä¼˜å…ˆäºå…¶ä»–æ£€æŸ¥

3. **çŠ¶æ€è¦æ±‚**ï¼šåªæœ‰åœ¨ `thinking` çŠ¶æ€ä¸‹æ‰ä¼šè§¦å‘ç©ºè½®æ¬¡å¤„ç†ï¼Œé¿å…è¯¯åˆ¤

4. **æ—¥å¿—è§‚å¯Ÿ**ï¼šå¼€å‘æ—¶å¯é€šè¿‡çº¢è‰²é†’ç›®æ—¥å¿—å¿«é€Ÿå®šä½ `play_end` å‘é€æ—¶æœº

## ç›¸å…³ä¿®å¤

æœ¬æ¬¡ä¿®å¤åŒæ—¶è§£å†³äº†ä»¥ä¸‹é—®é¢˜ï¼š
- âœ… å»¶è¿ŸéŸ³é¢‘åŒ…é˜²æŠ¤ï¼ˆ500ms å†…çš„å»¶è¿ŸåŒ…è¢«å¿½ç•¥ï¼‰
- âœ… ç©ºè½®æ¬¡å¡ä½é—®é¢˜ï¼ˆè‡ªåŠ¨å‘é€ play_endï¼‰
- âœ… æ—¥å¿—å¯è§‚å¯Ÿæ€§å¢å¼ºï¼ˆé†’ç›®çš„çº¢è‰²æ—¥å¿—ï¼‰

