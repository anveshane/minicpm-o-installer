# LiveKit 连接性能诊断指南

## 📊 新增功能说明

为了排查测试环境中 LiveKit 连接房间耗时异常的问题（17808ms vs 正常的300-500ms），在 `useLiveKit.js` 中新增了详细的诊断日志功能。

---

## 🔍 诊断日志包含以下内容

### 1. **网络质量预检**（连接前）
- ✅ 在线状态检测
- 🌐 网络类型识别（4G/3G/2G）
- ⏱️ 网络延迟估计（RTT）
- 📶 带宽估计
- ⚠️ 自动预警（检测到慢速网络时）

### 2. **环境信息收集**
```javascript
📋 环境诊断信息:
- 浏览器：User Agent、厂商、版本
- 平台：操作系统类型
- 网络：连接类型、带宽、延迟
- LiveKit配置：服务器URL、协议、超时设置
- 内存：堆内存使用情况
```

### 3. **连接进度实时监控**
- ⏳ 每2秒输出一次连接进度
- 🚨 超过15秒自动预警
- 帮助判断连接是否卡住

### 4. **详细的连接状态追踪**
```
🔗 Room连接状态变化:
- connecting → 正在建立连接
- connected → 连接成功
- reconnecting → 重连中
- disconnected → 已断开
```

### 5. **ICE 连接诊断（重点！）**
```
🧊 ICE连接状态监控:
- 候选收集状态
- 连接建立过程
- 最终连接类型：
  ⚡ 直连（最快，局域网）
  🌐 STUN穿透（正常，公网NAT）
  🔄 TURN中继（慢，需要服务器中转）⚠️
```

**如果使用 TURN 中继，日志会显示警告和可能的原因！**

### 6. **各阶段耗时分析**
```
⏱️ LiveKit 房间加入耗时统计:
📊 总耗时: XXXXms
──────────────────────
1️⃣ 连接房间:        XXXms ⚠️/✅
2️⃣ 创建音频轨道:    XXXms ⚠️/✅
3️⃣ 创建视频轨道:    XXXms ⚠️/✅
4️⃣ 发布轨道:        XXXms ⚠️/✅
5️⃣ 初始化监听器:    XXXms
```

### 7. **性能基准对比**
```
📊 性能基准对比 (当前 vs 正常值)
──────────────────────
📊 总耗时:       XXXXms (正常: 3000ms)    🔴/🟠/🟢 X.Xx
🔗 连接房间:     XXXXms (正常: 400ms)     🔴/🟠/🟢 X.Xx
🎤 创建音频:     XXXms  (正常: 200ms)     🟢 X.Xx
🎥 创建视频:     XXXms  (正常: 500ms)     🟢 X.Xx
📡 发布轨道:     XXXXms (正常: 2000ms)    🟢 X.Xx
```

### 8. **智能诊断建议**
根据实际耗时自动给出问题分析和优化建议：

**连接房间慢（>5000ms）：**
- ❌ 网络延迟高
- ❌ DNS解析慢
- ❌ 防火墙/代理拦截
- ❌ LiveKit服务器响应慢
- ❌ 需要TURN中继

**音频轨道创建慢（>1000ms）：**
- ❌ 麦克风权限等待用户确认
- ❌ 音频设备初始化慢

**视频轨道创建慢（>2000ms）：**
- ❌ 摄像头权限等待
- ❌ 摄像头硬件初始化慢
- ❌ 多个应用占用摄像头

### 9. **完整诊断报告**
```javascript
📋 完整诊断报告 (可复制给开发者)
提示: 右键点击下方对象 → "Store as global variable" → 然后输入 copy(temp1) 复制
```

包含完整的环境、性能、网络信息，方便复制给开发者分析。

---

## 📝 测试步骤

### 对于测试同学：

1. **打开浏览器开发者工具**
   - Chrome/Edge: 按 `F12` 或 `Ctrl+Shift+I` (Windows) / `Cmd+Option+I` (Mac)
   - 切换到 `Console` 标签页

2. **开始连接测试**
   - 进入页面，触发 LiveKit 连接
   - 观察控制台输出的彩色日志

3. **重点关注以下信息**：

   #### 🔴 如果「连接房间」耗时 > 5000ms：
   - 查看「网络质量预检」结果（开头部分）
   - 查看「ICE连接状态」日志
   - 查看是否有「TURN中继」警告 ⚠️
   - 查看「诊断建议」部分

   #### 🔴 如果看到 TURN 中继警告：
   ```
   ⚠️ 检测到使用TURN中继连接！这会增加延迟
   ```
   这可能是主要原因！说明网络环境受限，无法直连。

4. **复制诊断报告**
   - 滚动到底部找到「📋 完整诊断报告」
   - 方法1：右键点击对象 → "Store as global variable" → 输入 `copy(temp1)`
   - 方法2：直接复制下方的「📄 文本版本」
   - 将报告发送给开发者

5. **多次测试对比**
   - 建议测试 3-5 次，记录每次的「连接房间」耗时
   - 观察是否稳定慢，还是偶尔慢

---

## 🔧 可能的问题和解决方案

### 问题1: 连接房间耗时 > 10000ms（检测到使用TURN中继）
**原因：** 网络环境严格限制，需要通过服务器中转数据

**可能的原因：**
- 公司网络防火墙严格
- 使用了代理服务器
- 路由器 NAT 类型为「对称型NAT」（最严格）
- UDP 流量被拦截

**解决方案：**
1. 尝试切换网络环境（如手机热点）
2. 检查防火墙设置，允许 WebRTC 流量
3. 检查是否启用了代理，尝试关闭
4. 联系网络管理员开放相关端口
5. 询问后端是否配置了TURN服务器优化

---

### 问题2: 连接房间耗时 2000-5000ms（未使用TURN）
**原因：** 网络延迟较高或DNS解析慢

**解决方案：**
1. 检查「网络延迟估计」（RTT）是否 > 200ms
2. 尝试更换DNS服务器（如 8.8.8.8 或 114.114.114.114）
3. 检查是否在使用VPN
4. Ping LiveKit 服务器域名，查看延迟

---

### 问题3: 音频/视频轨道创建慢
**原因：** 设备权限或硬件问题

**解决方案：**
1. 检查是否有权限请求弹窗未点击
2. 检查其他应用是否占用摄像头/麦克风
3. 重启浏览器
4. 检查设备管理器中的硬件状态

---

## 📊 性能基准参考

### 正常环境（开发者本地测试）：
```
总耗时:       ~3000ms
├─ 连接房间:     300-500ms   (占比: 13-17%)
├─ 创建音频:     ~200ms      (占比: 7%)
├─ 创建视频:     ~500ms      (占比: 17%)
└─ 发布轨道:     ~2000ms     (占比: 67%)
```

### 异常环境（测试同学反馈）：
```
总耗时:       ~20631ms  (⚠️ 6.9x 慢)
├─ 连接房间:     17808ms    (⚠️ 35-59x 慢!!!)  ← 主要问题！
└─ 其他阶段:     ~2823ms    (正常)
```

**分析：** 主要问题在「连接房间」阶段，其他阶段正常，高度怀疑是网络环境问题，特别是需要 TURN 中继。

---

## 💡 如何查看是否使用了 TURN 中继

在控制台中查找以下日志：

```javascript
📊 [诊断] ICE连接详情:
{
  本地候选: { 类型: "relay", ... },     // ← relay 表示使用TURN
  远程候选: { 类型: "relay", ... },     // ← relay 表示使用TURN
  连接类型: "🔄 TURN中继 (网络受限，延迟较高)"  // ← 关键提示！
}

⚠️ 检测到使用TURN中继连接！这会增加延迟，可能是因为:
   1. 设备处于严格的NAT/防火墙环境
   2. 公司网络限制了P2P连接
   3. 代理服务器拦截了UDP流量
```

---

## 🎯 快速排查流程图

```
开始测试
  ↓
打开 Console
  ↓
触发连接
  ↓
观察「连接房间」耗时
  ↓
├─ < 1000ms ────→ ✅ 正常
├─ 1000-2000ms ─→ 🟡 略慢（可接受）
├─ 2000-5000ms ─→ 🟠 较慢（检查网络延迟/DNS）
└─ > 5000ms ────→ 🔴 异常！
      ↓
   查看 ICE 连接日志
      ↓
   ├─ 显示「TURN中继」────→ 网络环境受限（主要原因！）
   ├─ 显示「STUN穿透」────→ 网络延迟高
   └─ 显示「直连」────────→ LiveKit 服务器响应慢
```

---

## 📞 联系开发者

如果遇到问题，请提供：
1. ✅ 完整诊断报告（从 Console 复制）
2. ✅ 测试网络环境描述（公司网络/家庭网络/手机热点）
3. ✅ 是否使用代理/VPN
4. ✅ 浏览器版本
5. ✅ 多次测试的耗时数据

---

## 🔧 开发者备注

### 代码修改位置
- 文件：`src/hooks/useLiveKit.js`
- 函数：`joinRoom()`

### 新增功能清单
- [x] 环境信息收集（浏览器、网络、内存）
- [x] DNS/网络预检测试
- [x] 连接进度监控（每2秒）
- [x] 详细的连接状态追踪
- [x] ICE 连接诊断（检测 TURN 使用）
- [x] 各阶段耗时分析
- [x] 性能基准对比（与正常值对比）
- [x] 智能诊断建议
- [x] 完整诊断报告导出

### 后续优化方向
1. 如果确认是 TURN 中继问题，可以：
   - 优化 TURN 服务器部署（增加节点、优化路由）
   - 提供网络环境检测和建议（在 UI 中）
   - 添加连接质量评分
   
2. 可以添加一个「诊断模式」按钮，方便测试同学一键导出报告

3. 考虑将关键诊断信息上报到后端，用于统计分析

---

**版本：** v1.0.0  
**更新日期：** 2026-01-29  
**作者：** AI Assistant
