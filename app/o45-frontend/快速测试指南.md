# 无机器人超时功能 - 快速测试指南 🧪

## 📋 功能说明
房间连接后，如果没有检测到后端机器人加入，会自动提示用户并挂断。

### ⏱️ 超时时间（自动识别）
- **localhost 环境**：10秒（方便测试）
- **生产环境**：3分钟（正常超时）

> ✅ **智能识别**：代码会自动判断当前环境，无需手动修改！

---

## ✅ 测试方案（选一种即可）

### 方案一：自动超时测试（推荐）⭐

**步骤：**
1. 启动项目：`npm run dev`
2. 进入视频/语音通话页面
3. 点击"开始通话"
4. 打开浏览器控制台（F12）观察日志
5. 等待 10 秒（不让后端机器人加入）
6. 应该看到弹窗："连接超时，未能成功连接到服务，将自动挂断。"

**关键日志：**
```
⏰ 启动无机器人检测定时器 (10秒)...
⚠️ [时间戳] 10秒内未检测到机器人加入，准备挂断...
当前远端参与者数量: 0
```

---

### 方案二：手动触发测试 🎮

**步骤：**
1. 启动项目并开始通话
2. 打开浏览器控制台（F12）
3. 在控制台输入并执行：

**情况A：已开始通话且定时器活跃**
```javascript
window.__testNoRobotTimeout()
```

**情况B：未开始通话或想直接测试**
```javascript
// 使用强制模式，跳过定时器检查
window.__testNoRobotTimeout(true)
```

**查看当前状态**
```javascript
// 查看定时器状态
window.__checkTimerStatus()

// 查看完整调试信息
window.__debugInfo()
```

**优点：** 不用等待，立即测试

---

## 🔍 正常流程验证

如果后端机器人在10秒内成功加入，应该看到：
```
✅ 检测到远端参与者加入，清除无机器人检测定时器
```
此时不会触发超时提示。

---

## 📝 验证清单

- [ ] 无机器人时，10秒后弹出提示
- [ ] 点击确定后自动挂断
- [ ] 有机器人加入时，不会触发超时
- [ ] 手动挂断时，定时器被清除
- [ ] 手动测试函数 `window.__testNoRobotTimeout()` 可用

---

## ⚙️ 超时时间说明

**自动环境识别** - 无需手动修改！

代码会根据访问域名自动判断环境：

| 环境 | 判断条件 | 超时时间 |
|------|----------|----------|
| 本地开发 | `localhost` 或 `127.0.0.1` | 10秒 |
| 生产环境 | 其他域名 | 3分钟 |

**实现代码：** `src/hooks/useLiveKit.js`
```javascript
const isLocalhost = window.location.hostname === 'localhost' || 
                   window.location.hostname === '127.0.0.1';
const TIMEOUT_MS = isLocalhost ? 10 * 1000 : 3 * 60 * 1000;
```

---

## ✅ 上线无需修改

**好消息：** 代码已支持自动环境识别，上线时无需修改任何配置！

- 开发时：自动使用 10 秒（快速测试）
- 上线后：自动使用 3 分钟（正常超时）

---

## 🐛 常见问题与解决

### Q1: 执行 `window.__testNoRobotTimeout()` 什么都没发生？

**可能原因：**
1. 没有开始通话，定时器未启动
2. 定时器已经超时或被清除

**解决方法：**
```javascript
// 方法1：查看当前状态
window.__debugInfo()

// 方法2：使用强制模式
window.__testNoRobotTimeout(true)

// 方法3：查看定时器状态
window.__checkTimerStatus()
```

**预期输出：**
```
🧪 测试：triggerNoRobotTimeout 被调用 { hasTimer: false, force: false }
🧪 测试失败：没有活跃的无机器人检测定时器
🧪 提示：请先开始通话，或使用强制模式: triggerNoRobotTimeout(true)
```

---

### Q2: 定时器没有启动？

**检查步骤：**
```javascript
// 1. 查看调试信息
window.__debugInfo()

// 2. 检查是否已连接
// 应该看到 livekitConnected: true

// 3. 检查是否有远端参与者
// remoteParticipants 应该为 0（无机器人）
```

**正常情况：** 如果显示"房间已有远端参与者"，说明机器人已加入，不会启动定时器（这是正常的）

---

### Q3: 控制台找不到测试函数？

**检查：**
```javascript
// 查看测试函数是否存在
console.log(typeof window.__testNoRobotTimeout)
// 应该输出 'function'
```

**原因：** 测试函数只在开发环境暴露
- 确保运行 `npm run dev`（开发模式）
- 确保页面已加载完成
- 刷新页面重试

---

### Q4: 超时后没有挂断？

**检查控制台日志：**
```
🧪 触发结果: true
🧪 执行挂断流程...
```

**如果没有这些日志：**
- 检查是否弹出了 alert 对话框
- 检查 `stopRecording` 函数是否存在错误
- 查看控制台是否有其他错误信息

---

## 📦 相关文件

- `src/hooks/useLiveKit.js` - 核心逻辑
- `src/views/home/components/Video_new_rtc.vue` - 视频通话组件
- `src/views/home/components/Voice_new_rtc.vue` - 语音通话组件
- `TEST_NO_ROBOT_TIMEOUT.md` - 详细测试文档

---

## 🎯 快速测试命令参考

### 测试超时功能
```javascript
// 1. 正常测试（需要已开始通话）
window.__testNoRobotTimeout()

// 2. 强制测试（随时可用）
window.__testNoRobotTimeout(true)
```

### 查看状态信息
```javascript
// 查看完整调试信息（推荐）
window.__debugInfo()

// 仅查看定时器状态
window.__checkTimerStatus()

// 检查测试函数是否已加载
console.log('测试函数:', typeof window.__testNoRobotTimeout)
```

### 完整测试流程
```javascript
// 步骤1：开始通话

// 步骤2：查看当前状态
window.__debugInfo()
// 确认 livekitConnected: true

// 步骤3：触发超时测试
window.__testNoRobotTimeout()
// 或强制触发
window.__testNoRobotTimeout(true)

// 步骤4：确认弹窗出现并自动挂断
```

---

**测试愉快！** 🚀

