# 无机器人超时功能测试指南

## 功能说明
当用户加入房间后，如果3分钟内没有检测到后端机器人加入，会自动提示用户并挂断连接。

## 测试方案

### 方案一：自动超时测试（推荐）

**当前配置：10秒超时（测试模式）**

#### 测试步骤：
1. 启动项目并进入通话页面
2. 点击"开始通话"或"加入房间"
3. 观察浏览器控制台，会看到：
   ```
   ⏰ 启动无机器人检测定时器 (10秒)...
   ```
4. 等待10秒（如果后端机器人未加入）
5. 应该看到控制台输出：
   ```
   ⚠️ [时间戳] 10秒内未检测到机器人加入，准备挂断...
   当前远端参与者数量: 0
   ```
6. 浏览器会弹出提示框："连接超时，未能成功连接到服务，将自动挂断。"
7. 点击确定后，会自动执行挂断流程

#### 正常情况测试：
1. 如果后端机器人在10秒内加入，控制台会输出：
   ```
   ✅ 检测到远端参与者加入，清除无机器人定时器
   ```
2. 不会触发超时提示

---

### 方案二：手动触发测试

#### 测试步骤：
1. 启动项目并进入通话页面
2. 点击"开始通话"或"加入房间"
3. 打开浏览器控制台（F12）
4. 在控制台输入以下命令手动触发超时：
   ```javascript
   // 导入测试函数
   import { triggerNoRobotTimeout } from '@/hooks/useLiveKit.js'
   
   // 手动触发超时
   triggerNoRobotTimeout()
   ```
5. 或者直接在全局查找：
   ```javascript
   // 如果已经在 window 上暴露了
   window.__triggerNoRobotTimeout && window.__triggerNoRobotTimeout()
   ```

---

### 方案三：修改超时时间

如果需要测试不同的超时时间：

**文件位置：** `src/hooks/useLiveKit.js`

找到 `startNoRobotTimer` 函数中的这行代码：
```javascript
const TIMEOUT_MS = 10 * 1000; // 测试用10秒，正式：3 * 60 * 1000
```

修改为你想要的时间：
- 5秒测试：`5 * 1000`
- 30秒测试：`30 * 1000`
- 正式环境（3分钟）：`3 * 60 * 1000`

---

## 关键日志说明

### 正常流程日志：
```
✅ 房间已有远端参与者，无需启动无机器人检测定时器
```
或
```
⏰ 启动无机器人检测定时器 (10秒)...
✅ 检测到远端参与者加入，清除无机器人定时器
```

### 超时流程日志：
```
⏰ 启动无机器人检测定时器 (10秒)...
⚠️ [时间戳] 10秒内未检测到机器人加入，准备挂断...
当前远端参与者数量: 0
```

### 清理流程日志：
```
✅ 清除无机器人检测定时器（在 leaveRoom 或新连接时）
```

---

## 验证清单

- [ ] 房间已有参与者时，不启动定时器
- [ ] 房间无参与者时，启动定时器
- [ ] 参与者在超时前加入，定时器被清除
- [ ] 超时后弹出提示框
- [ ] 点击确定后执行挂断流程
- [ ] 手动挂断时清除定时器
- [ ] 重新加入房间时清除旧定时器

---

## 上线前注意事项

⚠️ **重要：上线前必须将超时时间改回3分钟！**

修改文件：`src/hooks/useLiveKit.js`

```javascript
// 将这行：
const TIMEOUT_MS = 10 * 1000; // 测试用10秒

// 改为：
const TIMEOUT_MS = 3 * 60 * 1000; // 正式：3分钟
```

---

## 故障排查

### 问题1：定时器没有启动
**检查：**
- 控制台是否有"✅ 房间已有远端参与者"日志？
- 如果有，说明房间已有参与者，不会启动定时器（正常）

### 问题2：超时后没有挂断
**检查：**
- leaveRoom 函数是否正常执行？
- 查看控制台是否有相关错误

### 问题3：参与者加入后仍然超时
**检查：**
- ParticipantConnected 事件是否被正确监听？
- 查看"检测到远端参与者加入"日志是否出现

---

## 测试建议

1. **快速测试：** 使用10秒超时
2. **压力测试：** 多次重复加入/离开房间
3. **边界测试：** 在超时临界点让机器人加入
4. **异常测试：** 网络断开、页面刷新等场景

