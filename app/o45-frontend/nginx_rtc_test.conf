user root;
worker_processes auto;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;

events {
	worker_connections 768;
	# multi_accept on;
}

http {

	##
	# Basic Settings
	##

	client_max_body_size 20M;

	sendfile on;
	tcp_nopush on;
	tcp_nodelay on;
	keepalive_timeout 65;
	types_hash_max_size 2048;
	# server_tokens off;

	# server_names_hash_bucket_size 64;
	# server_name_in_redirect off;

	include /etc/nginx/mime.types;
	default_type application/octet-stream;

	##
	# SSL Settings
	##

	ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; # Dropping SSLv3, ref: POODLE
	ssl_prefer_server_ciphers on;

	##
	# Logging Settings
	##

	access_log /var/log/nginx/access.log;
	error_log /var/log/nginx/error.log;

	##
	# Gzip Settings
	##

	gzip on;

	# gzip_vary on;
	# gzip_proxied any;
	# gzip_comp_level 6;
	# gzip_buffers 16 8k;
	# gzip_http_version 1.1;
	# gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # =============================
    # URL 参数使用说明
    # =============================
    # 用户可以在页面 URL 中传入以下参数来动态配置后端服务：
    #
    # Login 服务配置：
    #   - login_url: 登录服务主机地址（支持 IP、域名、localhost 等）
    #   - login_port: 登录服务端口号
    #   示例: ?login_url=localhost&login_port=8080
    #   示例: ?login_url=192.168.1.100&login_port=9000
    #   示例: ?login_url=api.example.com&login_port=443
    #
    # RTC 服务配置：
    #   - rtc_url: RTC 服务主机地址（支持 IP、域名、localhost 等）
    #   - rtc_port: RTC 服务端口号
    #   示例: ?rtc_url=localhost&rtc_port=7880
    #   示例: ?rtc_url=10.0.0.50&rtc_port=8020
    #
    # 完整示例：
    #   http://your-site.com/?login_url=localhost&login_port=8080&rtc_url=localhost&rtc_port=7880
    #
    # 如果不提供参数，将使用默认值：
    #   - login_url 默认: 10.158.0.32
    #   - login_port 默认: 8021
    #   - rtc_url 默认: 10.158.0.32
    #   - rtc_port 默认: 8020
    # =============================

    # Map port query parameter to backend URL
    map $arg_port $backend {
        default http://10.158.0.18:8020;
        "30081" http://10.17.8.181:30081;
        "32551" http://10.17.10.217:32551;
        "8020" http://10.17.8.4:8020;
        "8021" http://10.17.8.4:8021;
        "8022" http://10.17.8.4:8022;
        "8023" http://10.17.8.4:8023;
        "8024" http://10.17.8.4:8024;
        "8025" http://10.17.8.4:8025;
        "8026" http://10.17.8.4:8026;
        "8027" http://10.17.8.4:8027;
        "8028" http://10.17.8.4:8028;
        "8029" http://10.17.8.4:8029;
        "8030" http://10.17.8.4:8030;
        "8031" http://10.17.8.4:8031;
        "8032" http://10.17.8.4:8032;
        "8033" http://10.17.8.4:8033;
        "8034" http://10.17.8.4:8034;
        "8035" http://10.17.8.4:8035;
        "8036" http://10.17.8.4:8036;
        "8037" http://10.17.8.4:8037;
        "8038" http://10.17.8.4:8038;
        "8039" http://10.17.8.4:8039;
        "8040" http://10.17.8.4:8040;
        "8041" http://10.17.8.4:8041;
        "8042" http://10.17.8.4:8042;
        "8043" http://10.17.8.4:8043;
        "8044" http://10.17.8.4:8044;
        "8045" http://10.17.8.4:8045;
        "8046" http://10.17.8.4:8046;
        "8047" http://10.17.8.4:8047;
        "8048" http://10.17.8.4:8048;
        "8049" http://10.17.8.4:8049;
        "32449" http://10.17.8.8:32449;
        "32550" http://10.17.8.8:32550;
        "8000" http://10.17.10.217:8000;
        "8001" http://10.17.10.217:8001;
        "8002" http://10.17.10.217:8002;
        "8003" http://10.17.10.217:8003;
        "8004" http://10.17.10.217:8004;
        "8010" http://10.17.10.217:8010;
        "8011" http://10.17.10.217:8011;
        "8012" http://10.17.10.217:8012;
        "8013" http://10.17.10.217:8013;
        "8014" http://10.17.10.217:8014;
        "8081" http://10.17.8.181:8081;
    }

    # =============================
    # Flexible mapping for LOGIN group
    # =============================
    # Map login_url (支持任意主机：IP、域名、localhost等)
    # 如果未提供，默认使用 10.158.0.32
    map $arg_login_url $login_host_base {
        "" 10.158.0.32;  # 空值时使用默认值
        default $arg_login_url;  # 其他情况直接使用用户提供的值
    }
    
    # Map login_port (支持任意端口)
    # 如果未提供，默认使用 8021
    map $arg_login_port $login_port_value {
        "" 8035;  # 空值时使用默认值
        default $arg_login_port;  # 其他情况直接使用用户提供的值
    }

    # =============================
    # Flexible mapping for RTC group
    # =============================
    # Map rtc_url (支持任意主机：IP、域名、localhost等)
    # 如果未提供，默认使用 10.158.0.32
    map $arg_rtc_url $rtc_host_base {
        "" 47.93.211.211;  # 空值时使用默认值
        default $arg_rtc_url;  # 其他情况直接使用用户提供的值
    }
    
    # Map rtc_port (支持任意端口)
    # 如果未提供，默认使用 8020
    map $arg_rtc_port $rtc_port_value {
        "" 7880;  # 空值时使用默认值
        default $arg_rtc_port;  # 其他情况直接使用用户提供的值
    }
    ##
	# Virtual Host Configs
	##
	server {
		#	listen 8080;
		server_name localhost;

		add_header Access-Control-Allow-Origin *;
		add_header Access-Control-Allow-Headers X-Requested-With;
		add_header Access-Control-Allow-Methods GET,POST,OPTIONS;

		# Compose backends from two-level mappings
		set $login_backend http://$login_host_base:$login_port_value;
		set $rtc_backend   http://$rtc_host_base:$rtc_port_value;

        # 后端请求

        # =============================
        # 区域化推理服务配置
        # =============================
        # 国内单工
        location /api/region1/inference/services {
            proxy_pass http://47.93.211.211:8023/api/inference/services;
            proxy_set_header Host $host;
            proxy_set_header Connection "";
            chunked_transfer_encoding off;
            proxy_set_header X-Accel-Buffering off;
            add_header X-Accel-Buffering off;
            proxy_http_version 1.1;
            # 关闭 Nginx 缓存
            proxy_buffering off;
            proxy_cache off;
            # 禁用 Nginx 默认缓冲条件
            sendfile off;
            tcp_nodelay on;
        }
        # 国内双工
        location /api/region2/inference/services {
            proxy_pass http://47.93.211.211:8022/api/inference/services;
            proxy_set_header Host $host;
            proxy_set_header Connection "";
            chunked_transfer_encoding off;
            proxy_set_header X-Accel-Buffering off;
            add_header X-Accel-Buffering off;
            proxy_http_version 1.1;
            # 关闭 Nginx 缓存
            proxy_buffering off;
            proxy_cache off;
            # 禁用 Nginx 默认缓冲条件
            sendfile off;
            tcp_nodelay on;
        }

        # 美国单工
        location /api/region3/inference/services {
            proxy_pass http://34.135.164.183:8034/api/inference/services;
            proxy_set_header Host $host;
            proxy_set_header Connection "";
            chunked_transfer_encoding off;
            proxy_set_header X-Accel-Buffering off;
            add_header X-Accel-Buffering off;
            proxy_http_version 1.1;
            # 关闭 Nginx 缓存
            proxy_buffering off;
            proxy_cache off;
            # 禁用 Nginx 默认缓冲条件
            sendfile off;
            tcp_nodelay on;
        }

        # 美国双工
        location /api/region4/inference/services {
            proxy_pass http://34.135.164.183:8035/api/inference/services;
            proxy_set_header Host $host;
            proxy_set_header Connection "";
            chunked_transfer_encoding off;
            proxy_set_header X-Accel-Buffering off;
            add_header X-Accel-Buffering off;
            proxy_http_version 1.1;
            # 关闭 Nginx 缓存
            proxy_buffering off;
            proxy_cache off;
            # 禁用 Nginx 默认缓冲条件
            sendfile off;
            tcp_nodelay on;
        }

        # 欧洲单工
        location /api/region5/inference/services {
            proxy_pass http://34.178.28.73:8034/api/inference/services;
            proxy_set_header Host $host;
            proxy_set_header Connection "";
            chunked_transfer_encoding off;
            proxy_set_header X-Accel-Buffering off;
            add_header X-Accel-Buffering off;
            proxy_http_version 1.1;
            # 关闭 Nginx 缓存
            proxy_buffering off;
            proxy_cache off;
            # 禁用 Nginx 默认缓冲条件
            sendfile off;
            tcp_nodelay on;
        }

        # 欧洲双工
        location /api/region6/inference/services {
            proxy_pass http://34.178.28.73:8035/api/inference/services;
            proxy_set_header Host $host;
            proxy_set_header Connection "";
            chunked_transfer_encoding off;
            proxy_set_header X-Accel-Buffering off;
            add_header X-Accel-Buffering off;
            proxy_http_version 1.1;
            # 关闭 Nginx 缓存
            proxy_buffering off;
            proxy_cache off;
            # 禁用 Nginx 默认缓冲条件
            sendfile off;
            tcp_nodelay on;
        }

        # 印度单工
        location /api/region7/inference/services {
            proxy_pass http://34.131.182.85:8034/api/inference/services;
            proxy_set_header Host $host;
            proxy_set_header Connection "";
            chunked_transfer_encoding off;
            proxy_set_header X-Accel-Buffering off;
            add_header X-Accel-Buffering off;
            proxy_http_version 1.1;
            # 关闭 Nginx 缓存
            proxy_buffering off;
            proxy_cache off;
            # 禁用 Nginx 默认缓冲条件
            sendfile off;
            tcp_nodelay on;
        }

        # 印度双工
        location /api/region8/inference/services {
            proxy_pass http://34.131.182.85:8035/api/inference/services;
            proxy_set_header Host $host;
            proxy_set_header Connection "";
            chunked_transfer_encoding off;
            proxy_set_header X-Accel-Buffering off;
            add_header X-Accel-Buffering off;
            proxy_http_version 1.1;
            # 关闭 Nginx 缓存
            proxy_buffering off;
            proxy_cache off;
            # 禁用 Nginx 默认缓冲条件
            sendfile off;
            tcp_nodelay on;
        }

        # 查询推理服务状态的接口（默认）
        location /api/inference/services {
            proxy_pass https://minicpm-omni.modelbest.cn;
            proxy_set_header Host $host;
            proxy_set_header Connection "";
            chunked_transfer_encoding off;
            proxy_set_header X-Accel-Buffering off;  # 这里设置X-Accel-Buffering头部
            add_header X-Accel-Buffering off;         # 这里是用于响应中显示X-Accel-Buffering头部
            proxy_http_version 1.1;
            # 关闭 Nginx 缓存
            proxy_buffering off;
            proxy_cache off;
            # 禁用 Nginx 默认缓冲条件
            sendfile off;
            tcp_nodelay on;
        }

        # 这是https://minicpm-any.modelbest.cn/（国内版）的后端配置
        # location /api {
        #     proxy_pass http://47.93.211.211:8022;
        #     proxy_set_header Host $host;
        #     proxy_set_header Connection "";
        #     chunked_transfer_encoding off;
        #     proxy_set_header X-Accel-Buffering off;  # 这里设置X-Accel-Buffering头部
        #     add_header X-Accel-Buffering off;         # 这里是用于响应中显示X-Accel-Buffering头部
        #     proxy_http_version 1.1;
        #     # 关闭 Nginx 缓存
        #     proxy_buffering off;
        #     proxy_cache off;
        #     # 禁用 Nginx 默认缓冲条件
        #     sendfile off;
        #     tcp_nodelay on;
        # }

        # 这是https://minicpm-omni.modelbest.cn/的后端配置
        # location /api {
        #     proxy_pass http://10.32.0.221:8021;
        #     proxy_set_header Host $host;
        #     proxy_set_header Connection "";
        #     chunked_transfer_encoding off;
        #     proxy_set_header X-Accel-Buffering off;  # 这里设置X-Accel-Buffering头部
        #     add_header X-Accel-Buffering off;         # 这里是用于响应中显示X-Accel-Buffering头部
        #     proxy_http_version 1.1;
        #     # 关闭 Nginx 缓存
        #     proxy_buffering off;
        #     proxy_cache off;
        #     # 禁用 Nginx 默认缓冲条件
        #     sendfile off;
        #     tcp_nodelay on;
        # }

        # 单工语音服务
        location /api/python/login {
            proxy_pass http://47.93.211.211:8023/api/login;
            proxy_set_header Host $host;
            proxy_set_header Connection "";
            chunked_transfer_encoding off;
            proxy_set_header X-Accel-Buffering off;
            add_header X-Accel-Buffering off;
            proxy_http_version 1.1;
            # 关闭 Nginx 缓存
            proxy_buffering off;
            proxy_cache off;
            # 禁用 Nginx 默认缓冲条件
            sendfile off;
            tcp_nodelay on;
        }

        # 双工视频服务
        location /api/cpp/login {
            proxy_pass http://47.93.211.211:8022/api/login;
            proxy_set_header Host $host;
            proxy_set_header Connection "";
            chunked_transfer_encoding off;
            proxy_set_header X-Accel-Buffering off;
            add_header X-Accel-Buffering off;
            proxy_http_version 1.1;
            # 关闭 Nginx 缓存
            proxy_buffering off;
            proxy_cache off;
            # 禁用 Nginx 默认缓冲条件
            sendfile off;
            tcp_nodelay on;
        }

        # 这是https://omni-compare-test.modelbest.cn/的后端配置（李靖正在测试的版本）
        location /api {
            proxy_pass http://47.93.211.211:8023;
            proxy_set_header Host $host;
            proxy_set_header Connection "";
            chunked_transfer_encoding off;
            proxy_set_header X-Accel-Buffering off;  # 这里设置X-Accel-Buffering头部
            add_header X-Accel-Buffering off;         # 这里是用于响应中显示X-Accel-Buffering头部
            proxy_http_version 1.1;
            # 关闭 Nginx 缓存
            proxy_buffering off;
            proxy_cache off;
            # 禁用 Nginx 默认缓冲条件
            sendfile off;
            tcp_nodelay on;
        }
        
        # 这是h100的后端配置
        # location /api {
        #     proxy_pass http://10.32.0.221:8022;
        #     proxy_set_header Host $host;
        #     proxy_set_header Connection "";
        #     chunked_transfer_encoding off;
        #     proxy_set_header X-Accel-Buffering off;  # 这里设置X-Accel-Buffering头部
        #     add_header X-Accel-Buffering off;         # 这里是用于响应中显示X-Accel-Buffering头部
        #     proxy_http_version 1.1;
        #     # 关闭 Nginx 缓存
        #     proxy_buffering off;
        #     proxy_cache off;
        #     # 禁用 Nginx 默认缓冲条件
        #     sendfile off;
        #     tcp_nodelay on;
        # }

        # 这是给chongyi的后端配置
        # location /api {
        #     proxy_pass $login_backend;
        #     proxy_set_header Host $host;
        #     proxy_set_header Connection "";
        #     chunked_transfer_encoding off;
        #     proxy_set_header X-Accel-Buffering off;  # 这里设置X-Accel-Buffering头部
        #     add_header X-Accel-Buffering off;         # 这里是用于响应中显示X-Accel-Buffering头部
        #     proxy_http_version 1.1;
        #     # 关闭 Nginx 缓存
        #     proxy_buffering off;
        #     proxy_cache off;
        #     # 禁用 Nginx 默认缓冲条件
        #     sendfile off;
        #     tcp_nodelay on;
        # }
        # 后端请求
        location /v1/login/api {
            proxy_pass https://login-service.modelbest.cn;
            proxy_set_header Host login-service.modelbest.cn;
            proxy_set_header Connection "";
            chunked_transfer_encoding off;
            proxy_set_header X-Accel-Buffering off;  # 这里设置X-Accel-Buffering头部
            add_header X-Accel-Buffering off;         # 这里是用于响应中显示X-Accel-Buffering头部
            proxy_http_version 1.1;
            # 关闭 Nginx 缓存
            proxy_buffering off;
            proxy_cache off;
            # 禁用 Nginx 默认缓冲条件
            sendfile off;
            tcp_nodelay on;
        }
        # 后端请求
        location /login {
            proxy_pass $login_backend;
            proxy_set_header Host $host;
            proxy_set_header Connection "";
            chunked_transfer_encoding off;
            proxy_set_header X-Accel-Buffering off;  # 这里设置X-Accel-Buffering头部
            add_header X-Accel-Buffering off;         # 这里是用于响应中显示X-Accel-Buffering头部
            proxy_http_version 1.1;
            # 关闭 Nginx 缓存
            proxy_buffering off;
            proxy_cache off;
            # 禁用 Nginx 默认缓冲条件
            sendfile off;
            tcp_nodelay on;
        }
        # 后端请求
        location /logout {
            proxy_pass $login_backend;
            proxy_set_header Host $host;
            proxy_set_header Connection "";
            chunked_transfer_encoding off;
            proxy_set_header X-Accel-Buffering off;  # 这里设置X-Accel-Buffering头部
            add_header X-Accel-Buffering off;         # 这里是用于响应中显示X-Accel-Buffering头部
            proxy_http_version 1.1;
            # 关闭 Nginx 缓存
            proxy_buffering off;
            proxy_cache off;
            # 禁用 Nginx 默认缓冲条件
            sendfile off;
            tcp_nodelay on;
        }
        # 后端请求
        location /download {
            proxy_pass $login_backend;
            proxy_set_header Host $host;
            proxy_set_header Connection "";
            chunked_transfer_encoding off;
            proxy_set_header X-Accel-Buffering off;  # 这里设置X-Accel-Buffering头部
            add_header X-Accel-Buffering off;         # 这里是用于响应中显示X-Accel-Buffering头部
            proxy_http_version 1.1;
            # 关闭 Nginx 缓存
            proxy_buffering off;
            proxy_cache off;
            # 禁用 Nginx 默认缓冲条件
            sendfile off;
            tcp_nodelay on;
        }
        location /ws {
            proxy_pass $rtc_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }
        location /rtc {
            proxy_pass $rtc_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }

		location / {
			root /usr/share/nginx/html;

			index index.html index.htm;
			try_files $uri $uri/ /index.html;
		}

		location @router {
			rewrite ^.*$ /index.html last;
		}

		location =/robots.txt {
			index robots.txt;
		}

	}
}